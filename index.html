<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>SpendCount AI - Expense Tracker</title>
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#4A90E2">
    <link rel="icon" href="icons/icon-192x192.png" type="image/png">
    <link rel="apple-touch-icon" href="icons/icon-192x192.png">
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background-color: #f4f7f6;
            color: #333;
            margin: 0;
            padding: 20px;
            overscroll-behavior: none;
        }
        .container {
            max-width: 600px;
            margin: 0 auto;
            background-color: #ffffff;
            padding: 25px;
            border-radius: 12px;
            box-shadow: 0 6px 20px rgba(0, 0, 0, 0.07);
        }
        h1, h2, h3 {
            color: #2c3e50;
            border-bottom: 2px solid #ecf0f1;
            padding-bottom: 8px;
            font-weight: 600;
        }
        h1 {
            text-align: center;
            font-size: 1.8em;
            color: #4A90E2;
            border: none;
        }
        .budget-summary {
            background-color: #ecf0f1;
            padding: 20px;
            border-radius: 10px;
            text-align: center;
            margin-bottom: 25px;
        }
        .budget-summary h2 {
            margin: 0 0 10px 0;
            font-size: 1.1em;
            color: #7f8c8d;
            text-transform: uppercase;
            border: none;
        }
        .budget-summary .amount {
            font-size: 2.5em;
            font-weight: 700;
            color: #2c3e50;
        }
        form {
            margin-bottom: 25px;
        }
        .form-group {
            margin-bottom: 15px;
        }
        label {
            display: block;
            margin-bottom: 5px;
            font-weight: 600;
            font-size: 0.95em;
        }
        input[type="text"],
        input[type="number"],
        input[type="date"],
        select {
            width: 100%;
            padding: 12px;
            border: 1px solid #bdc3c7;
            border-radius: 8px;
            box-sizing: border-box; /* Important for padding to work with 100% width */
            font-size: 1em;
        }
        button {
            background-color: #4A90E2;
            color: white;
            padding: 12px 18px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            width: 100%;
            font-size: 1.05em;
            font-weight: 600;
            transition: background-color 0.3s ease;
        }
        button:hover {
            background-color: #357ABD;
        }
        button:disabled {
            background-color: #95a5a6;
            cursor: not-allowed;
        }
        ul {
            list-style-type: none;
            padding: 0;
        }
        li {
            background-color: #fafafa;
            padding: 15px;
            margin-bottom: 10px;
            border: 1px solid #ecf0f1;
            border-radius: 8px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
        }
        li .info {
            flex-grow: 1;
        }
        li .info strong {
            font-size: 1.1em;
            color: #2c3e50;
        }
        li .info .category {
            font-size: 0.9em;
            color: #7f8c8d;
            display: block;
            margin-top: 5px;
        }
        li .info .date-time {
            font-size: 0.8em;
            color: #95a5a6;
            display: block;
            margin-top: 5px;
        }
        li .amount {
            font-size: 1.2em;
            font-weight: 600;
        }
        .expense .amount { color: #e74c3c; }
        .income .amount, .loan .amount, .debt .amount { color: #2ecc71; }
        .planned .amount { color: #f39c12; }
        
        .tab-content {
            display: none;
        }
        .tab-content.active {
            display: block;
        }
        .tabs {
            display: flex;
            flex-wrap: wrap; /* Allow tabs to wrap on small screens */
            margin-bottom: 20px;
            border-bottom: 2px solid #ecf0f1;
        }
        .tab-link {
            padding: 10px 15px;
            cursor: pointer;
            background-color: #ecf0f1;
            border: none;
            font-size: 0.95em;
            font-weight: 600;
            color: #7f8c8d;
            border-top-left-radius: 8px;
            border-top-right-radius: 8px;
            margin-right: 5px;
            margin-bottom: -2px; /* Aligns with the border */
        }
        .tab-link.active {
            background-color: #4A90E2;
            color: #ffffff;
        }

        .category-budget-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
        }
        .category-budget-item .info {
            flex-grow: 1;
        }
        .category-budget-item .status {
            font-weight: 600;
            font-size: 0.95em;
        }
        .status.over-budget {
            color: #e74c3c;
        }
        .status.under-budget {
            color: #2ecc71;
        }
        .ai-tip {
            font-size: 0.9em;
            color: #34495e;
            background-color: #ecf0f1;
            padding: 10px;
            margin-top: 10px;
            border-radius: 6px;
            border-left: 4px solid #4A90E2;
            width: 100%;
        }
        .ai-tip.loading {
            color: #7f8c8d;
            font-style: italic;
        }
        .delete-btn {
            background: #e74c3c;
            color: white;
            border: none;
            padding: 5px 8px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 0.8em;
            margin-left: 10px;
        }
        .suggest-btn {
            background: #2ecc71;
            color: white;
            border: none;
            padding: 5px 10px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 0.9em;
            margin-left: 10px;
            width: auto; /* Override full width */
        }
        li.suggestion-item .info {
            font-size: 1em;
            color: #34495e;
        }

        /* AI Scan Styles */
        #scan-receipt-form {
            border: 2px dashed #4A90E2;
            padding: 20px;
            border-radius: 10px;
            background-color: #fafdff;
        }
        #ai-response {
            margin-top: 20px;
            padding: 15px;
            background-color: #ecf0f1;
            border-radius: 8px;
            display: none; /* Hidden by default */
        }
        #ai-response.loading,
        #financial-report-response.loading {
            display: block;
            text-align: center;
            color: #7f8c8d;
            font-style: italic;
            padding: 20px;
            background-color: #fafdff;
        }
        #ai-response.error,
        #financial-report-response.error {
            display: block;
            background-color: #ffebee;
            color: #c0392b;
            border: 1px solid #e74c3c;
            padding: 15px;
        }
        #ai-response pre {
            white-space: pre-wrap;
            word-wrap: break-word;
            font-family: monospace;
            background-color: #fff;
            padding: 10px;
            border-radius: 5px;
        }
        
        /* AI Financial Report Styles */
        #financial-report-response {
            margin-top: 20px;
            padding: 15px;
            background-color: #fafdff;
            border: 1px solid #ecf0f1;
            border-radius: 8px;
            display: none; /* Hidden by default */
            white-space: pre-wrap; /* Allows formatting from AI */
        }
        /* Styles for the AI-generated HTML */
        #financial-report-response h3 {
            color: #4A90E2;
            border-bottom: 1px solid #4A90E2;
            padding-bottom: 5px;
        }
        #financial-report-response ul {
            list-style-type: disc;
            padding-left: 20px;
        }
        #financial-report-response li {
            background: none;
            padding: 5px 0;
            margin-bottom: 0;
            border: none;
            display: list-item;
        }
    </style>
</head>
<body>

    <div class="container">
        <h1>SpendCount AI ðŸ’¸</h1>

        <div class="budget-summary">
            <h2>Total Budget</h2>
            <div class="amount" id="total-budget">$0.00</div>
        </div>

        <div class="tabs">
            <button class="tab-link active" onclick="openTab(event, 'dashboard')">Dashboard</button>
            <button class="tab-link" onclick="openTab(event, 'add')">Add</button>
            <button class="tab-link" onclick="openTab(event, 'plan')">Plan</button>
            <button class="tab-link" onclick="openTab(event, 'scan')">Scan AI</button>
            <button class="tab-link" onclick="openTab(event, 'ai-insights')">AI Insights</button>
        </div>

        <div id="dashboard" class="tab-content active">
            
            <h3>Recurring Expenses for This Month</h3>
            <ul id="recurring-suggestions-list">
                </ul>

            <hr>

            <div class="form-group">
                <h3>Set Category Budgets</h3>
                <form id="category-budget-form">
                    <div class="form-group">
                        <label for="budget-category">Category:</label>
                        <select id="budget-category" required>
                            <option value="Food">Food</option>
                            <option value="Transport">Transport</option>
                            <option value="Utilities">Utilities</option>
                            <option value="Rent">Rent</option>
                            <option value="Entertainment">Entertainment</option>
                            <option value="Shopping">Shopping</option>
                            <option value="Health">Health</option>
                            <option value="Education">Education</option>
                            <option value="Electronics and Gadget">Electronics and Gadget</option>
                            <option value="Other">Other</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="budget-amount">Amount:</label>
                        <input type="number" id="budget-amount" min="0" step="0.01" required>
                    </div>
                    <button type="submit">Set Budget</button>
                </form>
                <ul id="category-budgets-list">
                    </ul>
            </div>
            
            <hr>

            <h3>Paid Expenses</h3>
            <ul id="transactions-list">
                </ul>

            <hr>
            
            <h3>Unpaid Expenses</h3>
            <ul id="planned-expenses-list">
                </ul>
        </div>

        <div id="add" class="tab-content">
            <h2>Add Transaction</h2>
            <form id="add-transaction-form">
                <div class="form-group">
                    <label for="type">Type:</label>
                    <select id="type" required>
                        <option value="Expense">Expense</option>
                        <option value="Income">Income</option>
                        <option value="Loan">Loan</option>
                        <option value="Debt">Debt</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="name">Name:</label>
                    <input type="text" id="name" required>
                </div>
                <div class="form-group">
                    <label for="amount">Amount:</label>
                    <input type="number" id="amount" min="0" step="0.01" required>
                </div>
                <div class="form-group" id="category-group">
                    <label for="category">Category:</label>
                    <select id="category" required>
                        <option value="Food">Food</option>
                        <option value="Transport">Transport</option>
                        <option value="Utilities">Utilities</option>
                        <option value="Rent">Rent</option>
                        <option value="Entertainment">Entertainment</option>
                        <option value="Shopping">Shopping</option>
                        <option value="Health">Health</option>
                        <option value="Education">Education</option>
                        <option value="Electronics and Gadget">Electronics and Gadget</option>
                        <option value="Other">Other</option>
                    </select>
                </div>
                <button type="submit">Add Transaction</button>
            </form>
        </div>

        <div id="plan" class="tab-content">
            <h2>Plan a One-Time Expense</h2>
            <form id="add-planned-expense-form">
                <div class="form-group">
                    <label for="planned-name">Name:</label>
                    <input type="text" id="planned-name" required>
                </div>
                <div class="form-group">
                    <label for="planned-amount">Amount:</label>
                    <input type="number" id="planned-amount" min="0" step="0.01" required>
                </div>
                <div class="form-group">
                    <label for="planned-category">Category:</label>
                    <select id="planned-category" required>
                        <option value="Food">Food</option>
                        <option value="Transport">Transport</option>
                        <option value="Utilities">Utilities</option>
                        <option value="Rent">Rent</option>
                        <option value="Entertainment">Entertainment</option>
                        <option value="Shopping">Shopping</option>
                        <option value="Health">Health</option>
                        <option value="Education">Education</option>
                        <option value="Electronics and Gadget">Electronics and Gadget</option>
                        <option value="Other">Other</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="planned-date">Payment Date:</label>
                    <input type="date" id="planned-date" required>
                </div>
                <button type="submit">Add One-Time Expense</button>
            </form>

            <hr>

            <h3>Manage Recurring Expenses</h3>
            <form id="add-recurring-expense-form">
                <div class="form-group">
                    <label for="recurring-name">Name (e.g., Netflix, Rent):</label>
                    <input type="text" id="recurring-name" required>
                </div>
                <div class="form-group">
                    <label for="recurring-amount">Amount:</label>
                    <input type="number" id="recurring-amount" min="0" step="0.01" required>
                </div>
                <div class="form-group">
                    <label for="recurring-category">Category:</label>
                    <select id="recurring-category" required>
                        <option value="Entertainment">Entertainment</option>
                        <option value="Rent">Rent</option>
                        <option valueA="Utilities">Utilities</option>
                        <option value="Transport">Transport</option>
                        <option value="Food">Food</option>
                        <option value="Shopping">Shopping</option>
                        <option value="Health">Health</option>
                        <option value="Education">Education</option>
                        <option value="Electronics and Gadget">Electronics and Gadget</option>
                        <option value="Other">Other</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="recurring-day">Day of Month Due (1-31):</label>
                    <input type="number" id="recurring-day" min="1" max="31" required>
                </div>
                <button type="submit">Add Recurring Expense</button>
            </form>

            <h3>My Recurring Expense Templates</h3>
            <ul id="recurring-expenses-list">
                </ul>

        </div>

        <div id="scan" class="tab-content">
            <h2>Scan Receipt with AI</h2>
            <form id="scan-receipt-form">
                <div class="form-group">
                    <label for="receipt-image">Upload Receipt Image:</label>
                    <input type="file" id="receipt-image" accept="image/*" required>
                </div>
                <button type="submit">Scan and Analyze</button>
            </form>
            <div id="ai-response">
                </div>
        </div>

        <div id="ai-insights" class="tab-content">
            <h2>AI Financial Insights ðŸ’¡</h2>
            <p>Get a personalized financial report based on all your app data. The AI will analyze your budget, spending, debts, and recurring expenses to give you actionable advice.</p>
            <button id="generate-report-btn">Generate My Financial Report</button>
            
            <div id="financial-report-response">
                </div>
        </div>

    </div>

    <script>
        // --- STATE MANAGEMENT ---
        let totalBudget = 0;
        let transactions = [];
        let plannedExpenses = [];
        let categoryBudgets = [];
        let recurringExpenses = []; 

        // --- DOM Elements ---
        const totalBudgetEl = document.getElementById('total-budget');
        const transactionsListEl = document.getElementById('transactions-list');
        const plannedExpensesListEl = document.getElementById('planned-expenses-list');
        const categoryBudgetsListEl = document.getElementById('category-budgets-list');
        const typeSelectEl = document.getElementById('type');
        const categoryGroupEl = document.getElementById('category-group');
        const recurringExpensesListEl = document.getElementById('recurring-expenses-list');
        const recurringSuggestionsListEl = document.getElementById('recurring-suggestions-list');
        const generateReportBtn = document.getElementById('generate-report-btn');
        const financialReportResponseEl = document.getElementById('financial-report-response');

        // --- Event Listeners ---
        document.addEventListener('DOMContentLoaded', loadState);
        document.getElementById('add-transaction-form').addEventListener('submit', addTransaction);
        document.getElementById('add-planned-expense-form').addEventListener('submit', addPlannedExpense);
        document.getElementById('category-budget-form').addEventListener('submit', addCategoryBudget);
        document.getElementById('scan-receipt-form').addEventListener('submit', handleAiScan);
        typeSelectEl.addEventListener('change', toggleCategory);
        document.getElementById('add-recurring-expense-form').addEventListener('submit', addRecurringExpense);
        generateReportBtn.addEventListener('click', handleFinancialReport);

        // --- FUNCTIONS ---

        function openTab(event, tabName) {
            let i, tabcontent, tablinks;
            tabcontent = document.getElementsByClassName("tab-content");
            for (i = 0; i < tabcontent.length; i++) {
                tabcontent[i].style.display = "none";
            }
            tablinks = document.getElementsByClassName("tab-link");
            for (i = 0; i < tablinks.length; i++) {
                tablinks[i].className = tablinks[i].className.replace(" active", "");
            }
            document.getElementById(tabName).style.display = "block";
            event.currentTarget.className += " active";
        }

        function toggleCategory() {
            const type = typeSelectEl.value;
            if (type === 'Expense' || type === 'Loan' || type === 'Debt') {
                categoryGroupEl.style.display = 'block';
            } else {
                categoryGroupEl.style.display = 'none';
            }
        }

        function addTransaction(event) {
            event.preventDefault();
            
            const type = document.getElementById('type').value;
            const name = document.getElementById('name').value;
            const amount = parseFloat(document.getElementById('amount').value);
            const category = document.getElementById('category').value;
            const dateTime = new Date();

            const transaction = {
                id: Date.now(),
                type,
                name,
                amount,
                category,
                dateTime: dateTime.toISOString() 
            };

            transactions.push(transaction);

            // FIX: Add Loan and Debt to total budget
            if (type === 'Income' || type === 'Loan' || type === 'Debt') {
                totalBudget += amount;
            } else if (type === 'Expense') {
                totalBudget -= amount;
            }

            // Automatically add Loan/Debt to unpaid expenses
            if (type === 'Loan' || type === 'Debt') {
                const plannedExpense = {
                    id: Date.now() + 1,
                    name: `${type}: ${name}`,
                    amount: amount,
                    category: category,
                    date: getNextMonthDate(), 
                    isUnpaid: true,
                    sourceId: null 
                };
                plannedExpenses.push(plannedExpense);
            }

            updateUI();
            saveState();
            event.target.reset();
            toggleCategory();
            openTab(event, 'dashboard'); 
        }

        function getNextMonthDate() {
            const today = new Date();
            today.setMonth(today.getMonth() + 1);
            return today.toISOString().split('T')[0];
        }

        function addPlannedExpense(event) {
            event.preventDefault();

            const name = document.getElementById('planned-name').value;
            const amount = parseFloat(document.getElementById('planned-amount').value);
            const category = document.getElementById('planned-category').value;
            const date = document.getElementById('planned-date').value;

            const plannedExpense = {
                id: Date.now(),
                name,
                amount,
                category,
                date, 
                isUnpaid: true,
                sourceId: null
            };

            plannedExpenses.push(plannedExpense);
            
            updateUI();
            saveState();
            event.target.reset();
            openTab(event, 'dashboard'); 
        }

        function addCategoryBudget(event) {
            event.preventDefault();
            
            const category = document.getElementById('budget-category').value;
            const amount = parseFloat(document.getElementById('budget-amount').value);

            const existingBudgetIndex = categoryBudgets.findIndex(b => b.category === category);
            
            if (existingBudgetIndex > -1) {
                categoryBudgets[existingBudgetIndex].amount = amount;
            } else {
                categoryBudgets.push({ category, amount });
            }

            updateUI();
            saveState();
            event.target.reset();
        }

        // --- Recurring Expense Functions ---

        function addRecurringExpense(event) {
            event.preventDefault();

            const name = document.getElementById('recurring-name').value;
            const amount = parseFloat(document.getElementById('recurring-amount').value);
            const category = document.getElementById('recurring-category').value;
            const day = parseInt(document.getElementById('recurring-day').value);

            const recurringExpense = {
                id: Date.now(),
                name,
                amount,
                category,
                day
            };

            recurringExpenses.push(recurringExpense);
            
            updateUI();
            saveState();
            event.target.reset();
        }

        function renderRecurringExpenses() {
            recurringExpensesListEl.innerHTML = '';

            if (recurringExpenses.length === 0) {
                recurringExpensesListEl.innerHTML = '<li>No recurring expense templates created yet.</li>';
                return;
            }

            recurringExpenses.forEach(r => {
                const li = document.createElement('li');
                li.innerHTML = `
                    <div class="info">
                        <strong>${r.name}</strong>
                        <span class="category">${r.category} | Due on Day ${r.day}</span>
                    </div>
                    <span class="amount">$${r.amount.toFixed(2)}</span>
                    <button class="delete-btn" onclick="deleteRecurringExpense(${r.id})">Delete</button>
                `;
                recurringExpensesListEl.appendChild(li);
            });
        }

        function deleteRecurringExpense(id) {
            recurringExpenses = recurringExpenses.filter(r => r.id !== id);
            updateUI();
            saveState();
        }

        function renderRecurringSuggestions() {
            recurringSuggestionsListEl.innerHTML = '';
            
            const today = new Date();
            const currentMonthYear = `${today.getFullYear()}-${(today.getMonth() + 1).toString().padStart(2, '0')}`;

            let suggestionsFound = 0;

            recurringExpenses.forEach(r => {
                const sourceId = `recur-${r.id}`;
                
                const alreadyAdded = plannedExpenses.some(p => 
                    p.sourceId === sourceId && p.date.startsWith(currentMonthYear)
                );

                if (!alreadyAdded) {
                    suggestionsFound++;
                    const li = document.createElement('li');
                    li.className = 'suggestion-item';
                    li.innerHTML = `
                        <div class="info">${r.name} - $${r.amount.toFixed(2)}</div>
                        <button class="suggest-btn" onclick="addSuggestedExpense(${r.id})">Add</button>
                    `;
                    recurringSuggestionsListEl.appendChild(li);
                }
            });

            if (suggestionsFound === 0) {
                recurringSuggestionsListEl.innerHTML = '<li>All recurring expenses are set for this month!</li>';
            }
        }

        function addSuggestedExpense(recurringId) {
            const template = recurringExpenses.find(r => r.id === recurringId);
            if (!template) return;

            const today = new Date();
            const year = today.getFullYear();
            const month = today.getMonth() + 1;
            const day = Math.min(template.day, new Date(year, month, 0).getDate());
            const formattedDate = `${year}-${month.toString().padStart(2, '0')}-${day.toString().padStart(2, '0')}`;

            const plannedExpense = {
                id: Date.now(),
                name: template.name,
                amount: template.amount,
                category: template.category,
                date: formattedDate,
                isUnpaid: true,
                sourceId: `recur-${template.id}`
            };

            plannedExpenses.push(plannedExpense);
            
            updateUI();
            saveState();
        }

        // --- Main App Logic ---

        function checkAndRolloverExpenses() {
            const today = new Date();
            today.setHours(0, 0, 0, 0); 

            let stateChanged = false;

            plannedExpenses.forEach(expense => {
                const expenseDate = new Date(expense.date);
                
                if (expense.isUnpaid && expenseDate < today) {
                    const newDate = new Date(expenseDate);
                    newDate.setMonth(newDate.getMonth() + 1);
                    expense.date = newDate.toISOString().split('T')[0];
                    stateChanged = true;
                }
            });

            if (stateChanged) {
                saveState();
            }
        }

        function updateUI() {
            checkAndRolloverExpenses();

            totalBudgetEl.textContent = `$${totalBudget.toFixed(2)}`;
            
            renderTransactions();
            renderPlannedExpenses();
            renderCategoryBudgets();
            renderRecurringExpenses();
            renderRecurringSuggestions();
        }

        function renderTransactions() {
            transactionsListEl.innerHTML = '';
            
            const paidTransactions = transactions.filter(t => t.type === 'Expense' || t.type === 'Income');

            if (paidTransactions.length === 0) {
                transactionsListEl.innerHTML = '<li>No paid expenses or income yet.</li>';
                return;
            }

            paidTransactions.sort((a, b) => new Date(b.dateTime) - new Date(a.dateTime));

            paidTransactions.forEach(t => {
                const li = document.createElement('li');
                li.className = t.type.toLowerCase();
                
                const formattedDateTime = new Date(t.dateTime).toLocaleString(undefined, {
                    year: 'numeric',
                    month: 'short',
                    day: 'numeric',
                    hour: '2-digit',
                    minute: '2-digit'
                });

                li.innerHTML = `
                    <div class="info">
                        <strong>${t.name}</strong>
                        <span class="category">${t.category || t.type}</span>
                        <span class="date-time">${formattedDateTime}</span>
                    </div>
                    <span class="amount">
                        ${t.type === 'Expense' ? '-' : '+'}$${t.amount.toFixed(2)}
                    </span>
                `;
                transactionsListEl.appendChild(li);
            });
        }

        function renderPlannedExpenses() {
            plannedExpensesListEl.innerHTML = '';

            if (plannedExpenses.length === 0) {
                plannedExpensesListEl.innerHTML = '<li>No unpaid expenses.</li>';
                return;
            }
            
            plannedExpenses.sort((a, b) => new Date(a.date) - new Date(b.date));

            plannedExpenses.forEach(p => {
                const li = document.createElement('li');
                li.className = 'planned';

                const formattedDate = new Date(p.date).toLocaleDateString(undefined, {
                    year: 'numeric',
                    month: 'long',
                    day: 'numeric'
                });

                const isOverdue = new Date(p.date) < new Date() && p.isUnpaid;
                const overdueStyle = isOverdue ? 'style="color: #e74c3c;"' : '';

                li.innerHTML = `
                    <div class="info">
                        <strong ${overdueStyle}>${p.name}</strong>
                        <span class="category">${p.category}</span>
                        <span class="date-time" ${overdueStyle}>Due: ${formattedDate}</span>
                    </div>
                    <span class="amount">$${p.amount.toFixed(2)}</span>
                    <button class="delete-btn" onclick="deletePlannedExpense(${p.id})">Delete</button>
                `;
                plannedExpensesListEl.appendChild(li);
            });
        }

        function deletePlannedExpense(id) {
            plannedExpenses = plannedExpenses.filter(p => p.id !== id);
            updateUI();
            saveState();
        }

        function renderCategoryBudgets() {
            categoryBudgetsListEl.innerHTML = '';

            if (categoryBudgets.length === 0) {
                categoryBudgetsListEl.innerHTML = '<li>No category budgets set.</li>';
                return;
            }

            categoryBudgets.forEach(budget => {
                const li = document.createElement('li');
                li.className = 'category-budget-item';

                const spent = transactions
                    .filter(t => t.type === 'Expense' && t.category === budget.category)
                    .reduce((acc, t) => acc + t.amount, 0);

                const remaining = budget.amount - spent;
                let statusHtml = '';
                let aiTipHtml = `<div id="ai-tip-${budget.category.replace(/\s+/g, '-')}" class="ai-tip" style="display:none;"></div>`;

                if (remaining < 0) {
                    const overAmount = Math.abs(remaining);
                    statusHtml = `<span class="status over-budget">Over by $${overAmount.toFixed(2)}</span>`;
                    getBudgetAdvice(budget.category, overAmount);
                } else {
                    statusHtml = `<span class="status under-budget">$${remaining.toFixed(2)} left</span>`;
                }

                li.innerHTML = `
                    <div class="info">
                        <strong>${budget.category}</strong>
                        <span class="category">Budget: $${budget.amount.toFixed(2)} | Spent: $${spent.toFixed(2)}</span>
                    </div>
                    <div class="status">${statusHtml}</div>
                    ${aiTipHtml}
                `;
                categoryBudgetsListEl.appendChild(li);
            });
        }

        async function getBudgetAdvice(category, overAmount) {
            const tipElementId = `ai-tip-${category.replace(/\s+/g, '-')}`;
            const tipElement = document.getElementById(tipElementId);
            
            if (!tipElement || tipElement.classList.contains('loading') || tipElement.innerHTML !== '') {
                return;
            }
            
            tipElement.style.display = 'block';
            tipElement.classList.add('loading');
            tipElement.innerHTML = 'ðŸ¤– AI is generating a tip for you...';

            const model = 'gemini-pro';
            const prompt = {
                contents: [{
                    parts: [{
                        text: `I just overspent by $${overAmount.toFixed(2)} in my "${category}" budget category. Give me one single, short, practical tip (less than 30 words) to help me save money in this specific category.`
                    }]
                }]
            };

            try {
                const response = await fetch('/api/call-gemini', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ model, prompt }),
                });

                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(error.error || 'Failed to get tip from AI.');
                }

                const result = await response.json();
                tipElement.innerHTML = `ðŸ’¡ **AI Tip:** ${result.text}`;
            
            } catch (error) {
                console.error('AI Budget Tip Error:', error);
                tipElement.innerHTML = 'Could not load AI tip. Check connection.';
            } finally {
                tipElement.classList.remove('loading');
            }
        }

        // --- AI SCAN FUNCTIONS ---
        async function handleAiScan(event) {
            event.preventDefault();
            const imageInput = document.getElementById('receipt-image');
            const responseEl = document.getElementById('ai-response');

            if (!imageInput.files || imageInput.files.length === 0) {
                alert('Please select an image file.');
                return;
            }

            const file = imageInput.files[0];

            responseEl.className = 'loading';
            responseEl.innerHTML = 'Scanning and analyzing receipt... ðŸ¤–';

            try {
                const base64Image = await toBase64(file);
                const model = 'gemini-1.5-flash';
                const prompt = {
                    contents: [{
                        parts: [
                            { text: "Analyze this receipt image. Extract the total amount, vendor name, and date. Then, list the items with their prices. Finally, suggest an appropriate expense category (e.g., Food, Transport, Utilities, etc.). Respond ONLY in this exact JSON format: {\"vendor\": \"VendorName\", \"date\": \"YYYY-MM-DD\", \"total\": \"0.00\", \"category\": \"SuggestedCategory\", \"items\": [{\"name\": \"ItemName\", \"price\": \"0.00\"}]}" },
                            {
                                inlineData: {
                                    mimeType: file.type,
                                    data: base64Image
                                }
                            }
                        ]
                    }]
                };

                const response = await fetch('/api/call-gemini', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ model, prompt }),
                });

                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(error.error || 'Failed to analyze image.');
                }

                const result = await response.json();
                
                const jsonText = result.text.replace(/```json|```/g, '').trim();
                // *** THIS IS THE FIX ***
                const data = JSON.parse(jsonText);

                responseEl.className = '';
                responseEl.innerHTML = `
                    <h3>Scan Result</h3>
                    <p><strong>Vendor:</strong> ${data.vendor || 'N/A'}</p>
                    <p><strong>Total:</strong> $${data.total || '0.00'}</p>
                    <p><strong>Date:</strong> ${data.date || 'N/A'}</p>
                    <p><strong>Suggested Category:</strong> ${data.category || 'N/A'}</p>
                    <strong>Items:</strong>
                    <pre>${(data.items || []).map(item => `- ${item.name}: $${item.price}`).join('\n')}</pre>
                `;

            } catch (error) {
                console.error('AI Scan Error:', error);
                responseEl.className = 'error';
                responseEl.innerHTML = `<strong>Error:</strong> ${error.message}`;
            }
        }

        const toBase64 = file => new Promise((resolve, reject) => {
            const reader = new FileReader();
            reader.readAsDataURL(file);
            reader.onload = () => resolve(reader.result.split(',')[1]); 
            reader.onerror = error => reject(error);
        });
        
        // --- AI Financial Report Function ---
        async function handleFinancialReport(event) {
            event.target.disabled = true;
            financialReportResponseEl.className = 'loading';
            financialReportResponseEl.innerHTML = 'ðŸ¤– Analyzing your finances and generating your report... This may take a moment.';

            try {
                // 1. Aggregate all data
                const summary = buildFinancialSummary();
                
                // 2. Create the master prompt
                const model = 'gemini-pro';
                const promptText = `
                    You are a friendly and practical financial advisor. A user has provided a summary of their financial data. Your goal is to give them personalized, actionable advice based *only* on the data provided. Do not give generic advice.

                    Here is the user's financial summary:
                    ${summary}

                    Please analyze this data and answer the following three questions. Format your response in simple HTML. Use <h3> for the three main questions as headings, and <ul> with <li> for bullet points.

                    1.  Based on my spending, what are my top 3 specific opportunities to save money?
                    2.  How can I align my spending with my budget? (Look at my income vs. expenses, and my spending vs. my category budgets).
                    3.  What financial precautions should I take in the near future? (Look at my upcoming unpaid expenses, loans, and debts).
                `;

                const prompt = {
                    contents: [{ parts: [{ text: promptText }] }]
                };

                // 3. Call the API
                const response = await fetch('/api/call-gemini', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ model, prompt }),
                });

                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(error.error || 'Failed to get financial report from AI.');
                }

                const result = await response.json();
                
                // 4. Render the HTML response
                financialReportResponseEl.className = '';
                financialReportResponseEl.innerHTML = result.text; // AI generates the HTML

            } catch (error) {
                console.error('AI Report Error:', error);
                financialReportResponseEl.className = 'error';
                financialReportResponseEl.innerHTML = `<strong>Error:</strong> ${error.message}`;
            } finally {
                event.target.disabled = false;
            }
        }

        function buildFinancialSummary() {
            // Helper function to create a text summary of all app data
            
            // Summarize spending by category
            const spendingByCategory = {};
            transactions.filter(t => t.type === 'Expense').forEach(t => {
                spendingByCategory[t.category] = (spendingByCategory[t.category] || 0) + t.amount;
            });
            const spendingSummary = Object.keys(spendingByCategory)
                .map(cat => `- ${cat}: $${spendingByCategory[cat].toFixed(2)}`)
                .join('\n');

            const totalIncome = transactions
                .filter(t => t.type === 'Income')
                .reduce((acc, t) => acc + t.amount, 0);

            const totalExpenses = transactions
                .filter(t => t.type === 'Expense')
                .reduce((acc, t) => acc + t.amount, 0);

            return `
                CURRENT STATE:
                - Total Budget (Cash on Hand): $${totalBudget.toFixed(2)}
                - Total Income (this period): $${totalIncome.toFixed(2)}
                - Total Paid Expenses (this period): $${totalExpenses.toFixed(2)}

                MY SPENDING HABITS (Paid Expenses):
                ${spendingSummary || "- No expenses paid yet."}

                MY BUDGET LIMITS:
                ${categoryBudgets.map(b => `- ${b.category} Limit: $${b.amount.toFixed(2)}`).join('\n') || "- No category budgets set."}

                MY UPCOMING PAYMENTS (Unpaid Expenses):
                ${plannedExpenses.map(p => `- ${p.name} (Category: ${p.category}) for $${p.amount.toFixed(2)} due on ${p.date}`).join('\n') || "- No unpaid expenses."}
                
                MY RECURRING EXPENSE TEMPLATES:
                ${recurringExpenses.map(r => `- ${r.name} (Category: ${r.category}) for $${r.amount.toFixed(2)} due on day ${r.day}`).join('\n') || "- No recurring expense templates."}
            `;
        }


        // --- LOCAL STORAGE ---
        function saveState() {
            const state = {
                totalBudget,
                transactions,
                plannedExpenses,
                categoryBudgets,
                recurringExpenses
            };
            localStorage.setItem('spendCountState', JSON.stringify(state));
        }

        function loadState() {
            const state = JSON.parse(localStorage.getItem('spendCountState'));
            if (state) {
                totalBudget = state.totalBudget || 0;
                transactions = state.transactions || [];
                plannedExpenses = state.plannedExpenses || [];
                categoryBudgets = state.categoryBudgets || [];
                recurringExpenses = state.recurringExpenses || [];
            }
            openTab({ currentTarget: document.querySelector('.tab-link.active') }, 'dashboard');
            toggleCategory();
            updateUI(); 
        }
    </script>
</body>
</html>
